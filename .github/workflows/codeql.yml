# For Some projects, this workflow file will need changing.
# Try to only make changes for the languages you must.
# See 'Build Java' as a example

name: CodeQL for CW

on:
  push:
    branches: [develop, master, main, security/codeql]
  pull_request:
    branches: [develop, master, main, security/codeql]
  schedule:
    - cron: "18 15 * * 6"

concurrency:
  group: ${{ github.workflow }}-${{ github.ref }}
  cancel-in-progress: true

jobs:
  create-matrix:
    runs-on: ubuntu-22.04

    permissions:
      pull-requests: read
      contents: read

    outputs:
      matrix: ${{ steps.set-matrix.outputs.matrix }}

    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Get languages and base directories for each project
        id: set-matrix
        # This script will find all the projects in the repo and create a matrix of projects
        # The matrix will be used to run the CodeQL analysis on each project
        # To disable a language, remove the env variable for that language
        env:
          LANG_ACTIONS: none
          LANG_CPP: manual
          LANG_CPP_EXCLUDE: '"vendor/golang.org" "vendor/github.com"'
          LANG_CSHARP: none
          LANG_GO: autobuild
          LANG_JAVA: autobuild
          LANG_JAVASCRIPT: none
          LANG_PYTHON: none
          LANG_RUBY: none

          # You can MANUALLY OVERRIDE the matrix by providing a JSON file with the matrix.
          # This will fully override the automatic matrix creation
          # Matrix shape:
          # [{ "dir": "$SOMEPATH", "lang": "$LANG", "build-mode": "$BUILD_MODE" }, ...]
          MATRIX_OVERRIDE: ""
        run: bash ${GITHUB_WORKSPACE}/.github/workflows/scripts/codeql/codeql-project-gather.sh

  analyze:
    name: Analyze
    needs: create-matrix
    runs-on: ubuntu-22.04
    timeout-minutes: 360
    if: ${{ needs.create-matrix.outputs.matrix != '[]' }}
    strategy:
      fail-fast: false
      matrix:
        project: "${{fromJson(needs.create-matrix.outputs.matrix)}}"
    env:
      GOPRIVATE: github.com/coreweave
      GH_ACCESS_TOKEN: ${{ secrets.ORG_REPO_READ_ONLY }}
    permissions:
      # required for all workflows
      security-events: write
      # required to fetch internal or private CodeQL packs
      packages: read
      # only required for workflows in private repositories
      actions: read
      contents: read
    steps:
      - name: Checkout Repo
        uses: actions/checkout@v4
        with:
          fetch-depth: 1

      - name: Setup Github Access Token
        run: git config --global url.https://$GH_ACCESS_TOKEN@github.com/.insteadOf https://github.com/

      - name: Initialize CodeQL
        uses: github/codeql-action/init@v3
        with:
          languages: "${{ matrix.project.lang }}"
          build-mode: "${{ matrix.project.build-mode }}"
          source-root: "${{ matrix.project.dir }}"
          trap-caching: true
          dependency-caching: true

      - name: Setup Golang
        uses: actions/setup-go@v5
        if: ${{ matrix.project.lang == 'go' }}
        with:
          go-version-file: "${{ matrix.project.dir }}/go.mod"
          check-latest: true # WARNING: assumptions about build version
          cache: true # important to fast retest

      - name: List Dependancies Go Project
        id: go_list_deps
        if: ${{ matrix.project.lang == 'go' }}
        working-directory: ${{ matrix.project.dir }}
        run: |
          echo "go-mod-list<<EOF" >> $GITHUB_OUTPUT
          go mod edit -print >> $GITHUB_OUTPUT
          echo "EOF" >> $GITHUB_OUTPUT

      - name: Setup Buf
        if: ${{ matrix.project.lang == 'go'  && contains(steps.go_list_deps.outputs.go-mod-list, 'bsr.core-services.ingress.coreweave.com')}}
        uses: bufbuild/buf-action@v1
        with:
          setup_only: true # setup buf cli and only login to the registry
          version: ${{ needs.buf-version.outputs.bufVersion }}
          domain: bsr.core-services.ingress.coreweave.com
          token: ${{ secrets.ORG_BUF_TOKEN }}
          github_token: ${{ secrets.GITHUB_TOKEN }}

      - name: Install Dependancies Go Project
        if: ${{ matrix.project.lang == 'go' }}
        working-directory: ${{ matrix.project.dir }}
        run: |
          go mod download

      - name: Setup Python
        uses: actions/setup-python@v5
        if: ${{ matrix.project.lang == 'python' }}
        with:
          python-version: "3.12.x" # WARNING: assumptions about build version

      - name: Upgrade pip
        if: ${{ matrix.project.lang == 'python' }}
        run: |
          python -m pip install --upgrade pip
          exit 0

      # prefer poetry, then pipenv, then setup.py as a python module, then requirements.txt, then pyproject.toml
      # make the assumption that any project that has MULTIPLE methods knows what it's doing.
      # really, projects should have ONE package manager choice, but...
      - name: Install Python Dependencies
        continue-on-error: true
        if: ${{ matrix.project.lang == 'python' }}
        working-directory: ${{ matrix.project.dir }}
        run: |
          if [ -f poetry.lock ]; then
            python -m pip install 'poetry<1.8'
            poetry install --no-root
          elif [ -f Pipfile ]; then
            python -m pip install pipenv
            pipenv install
          elif [ -f setup.py ]; then
            python -m pip install .
          elif [ -f pyproject.toml ]; then
            python -m pip install .
          elif [ -f requirements.txt ]; then
            python -m pip install -r requirements.txt
          fi
          exit 0

      - name: Setup JavaScript
        uses: actions/setup-node@v4
        if: ${{ matrix.project.lang == 'javascript' }}
        with:
          # WARNING: unsafe assumption; the page depend on a specific version of NodeJS
          node-version: latest

      - name: Install JavaScript Dependencies
        continue-on-error: true
        if: ${{ matrix.project.lang == 'javascript' }}
        working-directory: ${{ matrix.project.dir }}
        run: |
          # WARNING: unsafe assumption; may want yarn instead of npm
          npm install
          exit 0

      - name: Setup Java
        # if we ever actually need this, it will need modification to install deps
        uses: actions/setup-java@v4
        if: ${{ matrix.project.lang == 'java-kotlin' }}
        with:
          distribution: temurin
          java-version: "14"

      - name: Build Java
        continue-on-error: true
        if: ${{ matrix.project.lang == 'java-kotlin' }}
        working-directory: ${{ matrix.project.dir }}
        run: |
          if [ -f pom.xml ]; then
            mvn -B -DskipTests=true -Dmaven.javadoc.skip=true clean install
          fi
          if [ -f build.gradle ]; then
            ./gradlew build
          fi
          if [ -f settings.gradle ]; then
            ./gradlew build
          fi
          exit 0

      - name: Build C/C++
        continue-on-error: true
        if: matrix.project.lang == 'cpp'
        working-directory: ${{ matrix.project.dir }}
        run: |
          echo "Put C/C++ build script here"
          exit 0

      - name: Build C#
        continue-on-error: true
        if: matrix.project.lang == 'csharp'
        working-directory: ${{ matrix.project.dir }}
        run: |
          echo "Put C# build script here"
          cd csharp
          dotnet build
          exit 0

      - name: Build Ruby
        continue-on-error: true
        if: matrix.project.lang == 'ruby'
        working-directory: ${{ matrix.project.dir }}
        run: |
          if [ -f Rakefile ]; then
            rake build
          elsif [ -f Gemfile ]; then
            : # do nothing for now
          fi
          exit 0

      - name: Perform CodeQL Analysis
        uses: github/codeql-action/analyze@v3
        with:
          category: "/language:${{ matrix.project.lang }}"
